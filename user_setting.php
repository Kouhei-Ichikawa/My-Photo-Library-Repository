<?php

//?Z?b?V?????̐錾
session_start();

$slide_speed = $_POST['slide_speed'];
$secret_status = $_POST['secret_status'];
$now_password = $_POST['now_password'];
$new_password = $_POST['new_password'];
$pass_change_flug = $_POST['pass_change_flug'];

//$secret_status?ﾍtrue,false?Œl?・轤ﾁ?Ă??驍ﾌ?ﾅvisible,hidden?ɕς??・
IF($secret_status == "true"){
	$secret_status = "visible";
}elseif($secret_status == "false"){
	$secret_status = "hidden";
}

//?f?[?^?x?[?X?ɐڑ?
$conn = oci_connect("photo_retrieval","********","localhost/IK_Photo_DB");
  if (!$conn) {
      $e = oci_error();
      trigger_error(htmlentities($e['message'], ENT_QUOTES), E_USER_ERROR);
  }

//?p?X???[?h?ﾏ?X???邩?ǂ????ŕ??・update?̕????ς墲・
IF($pass_change_flug == "true"){
	//?t???O??true?̏ꍇ?͌??݂̃p?X???[?h?m?F???驤ﾗ?̖₢???킹?s??
	//sql???̍쐬
	$sql = "SELECT password FROM photo_operation.user_table WHERE user_name = '" . $_SESSION['user_name'] . "'";

	//SQL???ﾀ?s???A?s???ʂ・stid?Ɋi?[
	$stid = oci_parse($conn, $sql);
	oci_execute($stid);

	//?s???ʂ̔z?・row?֊i?[
	$row = oci_fetch_array($stid, OCI_NUM);

	//???݂̃p?X???[?h?ƃt?H?[???œ・ﾍ???ꂽ?p?X???[?h???齟v???Ă??邩?m?F???・
	IF($row[0] <> $now_password){
		//?齟v???Ȃ??B??ꍇ?͂????ŏ????I??
		//?߂闥l?Ƃ??ﾄ"password_mismatch"?ƕԂ?
		exit("password_mismatch");

	}else{
		//?齟v?????ꍇ?͏????𑱍s
		$sql_parts = "password = '" . $new_password . "', ";
	}
}else{
	//pass_change_flug??false(?p?X???[?h?ﾏ?X???Ȃ?)?̏ꍇ?͈ȉ?
	$sql_parts = "";

}

//sql???̍쐬
$sql = "UPDATE user_table SET " . $sql_parts . "slide_speed = '" . $slide_speed . "', secret_status = '" . $secret_status . "' WHERE user_name = '" . $_SESSION['user_name'] . "'";

//???・p?̃??[?U?Ńf?[?^?x?[?X?ɐڑ?
$conn = oci_connect("photo_operation","********","localhost/IK_Photo_DB");
  if (!$conn) {
      $e = oci_error();
      trigger_error(htmlentities($e['message'], ENT_QUOTES), E_USER_ERROR);
  }

//SQL???ﾀ?s???A?s???ʂ・stid?Ɋi?[
$stid = oci_parse($conn, $sql);
oci_execute($stid);

//?߂闥l?Ƃ??ﾄ"success"?ƕԂ??ď????I??
echo "success";

?>